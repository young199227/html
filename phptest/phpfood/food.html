<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/mycolor.css">
    <title>food</title>

    <style>
        table {
            text-align: center;
        }

        table tr th {
            font-family: naikaifont;
            font-size: 35px;
        }

        table tr td {
            font-family: naikaifont;
            font-size: 20px;
        }

        @media screen and (max-width: 768px) {

            table {
                text-align: left;

            }

            table thead {
                display: none;
            }

            table tr {
                border: 4px solid rgb(152, 152, 152);
                border-radius: 15px;
                display: block;
            }

            table tr td {

                display: block;
                font-size: 18px;
            }

            table tr td:before {
                content: attr(data-th)" : ";

            }
        }
    </style>

</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col-md-6 offset-md-3 col-lg-4 offset-lg-4 mt-3">

                <div class="card">
                    <div class="card-body">

                        <form>

                            <div class="">

                                <label for="">品名</label>
                                <input type="text" id="pname" class="form-control" placeholder="2~8字">
                                <div class="form-text" id="err_pname">　</div>

                                <label for="">價錢</label>
                                <input type="text" id="price" class="form-control" placeholder="1~500">
                                <div class="form-text" id="err_price">　</div>

                                <label for="">座號</label>
                                <input type="number" id="pnum" class="form-control" placeholder="1-30" min="1" max="30">
                                <div class="form-text" id="err_pnum">　</div>

                            </div>

                            <div class="text-center mt-3">

                                <button type="button" class="btn btn-dark" id="die">清空</button>
                                <button type="button" class="btn btn-primary" id="ok">新增</button>

                            </div>

                        </form>

                    </div>
                </div>

            </div>
        </div>

        <div class="row">
            <div class="col-xl-8 offset-xl-2 mt-3">

                <table class="table">
                    <thead>
                        <tr>
                            <th>編號</th>
                            <th>品名</th>
                            <th>價錢</th>
                            <th>座號</th>
                            <th>訂購時間</th>
                        </tr>
                    </thead>
                    <tbody id="show">
                        <!-- <tr>
                            <td data-th="編號">1</td>
                            <td data-th="品名">1</td>
                            <td data-th="價錢">1</td>
                            <td data-th="數量">1</td>
                            <td data-th="訂購時間">1</td>
                        </tr> -->
                    </tbody>
                </table>

            </div>
        </div>
    </div>

</body>

<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/jquery-3.6.1.min.js"></script>

<script>

    //進入時讀取資料
    ajaxget();

    //判斷輸入框的變數
    var pname_state = false;
    var price_state = false;
    var pnum_state = false;

    //事件丟這裡
    $(function () {

        //按下新增 #ok click
        $("#ok").click(function () {

            // console.log(pname_state + " " + price_state + " " + pnum_state);

            if (pname_state && price_state && pnum_state) {

                var dataJson = {};

                dataJson["pname"] = $("#pname").val();
                dataJson["price"] = $("#price").val();
                dataJson["pnum"] = $("#pnum").val();

                // console.log(JSON.stringify(dataJson));

                $.ajax({

                    type: "POST",
                    url: "insert.php",
                    data: JSON.stringify(dataJson),
                    dataType: "json",
                    contentType: "application/json;chartset=utf-8",
                    success: function (data) {

                        //ajaxget()自定義的ajax拿資料方法
                        ajaxget();

                        //showClear()自定義的清除資訊欄方法
                        showClear();

                        alert(data.message);

                    },
                    error: function () {
                        console.log("ajax_error ajax新增失敗");
                    }

                });

            } else {

                //pValue()自定義的篩選資料方法
                pValue();

                //showClear自定義的清除資訊欄方法
                showClear();

                alert("資料不正確發送失敗");

            }

        });


        //輸入事件
        $("#pname").keyup(function () {

            if ($("#pname").val().length >= 2 && $("#pname").val().length <= 8) {

                $("#err_pname").html("正確").css("color", "green");

                pname_state = true;
            } else {

                $("#err_pname").html("2-8字").css("color", "red");

                pname_state = false;
            }
        });

        $("#price").keyup(function () {

            if ($("#price").val() >= 1 && $("#price").val() <= 500) {

                $("#err_price").html("正確").css("color", "green");

                price_state = true;

            } else {

                $("#err_price").html("價錢1-500").css("color", "red");

                price_state = false;
            }
        });

        $("#pnum").keyup(function () {

            if ($("#pnum").val() >= 1 && $("#pnum").val() <= 30) {

                $("#err_pnum").html("正確").css("color", "green");

                pnum_state = true;

            } else {

                $("#err_pnum").html("數量1-30").css("color", "red");

                pnum_state = false;
            }
        });


        //清空按鈕事件 showClear自定義的清除資訊欄方法
        $("#die").click(function () {

            showClear();
        });

    });


    //ajax拿資料
    function ajaxget() {

        var mony = 0;

        $.ajax({

            type: "post",
            url: "select.php",
            dataType: "json",
            success: function (data) {

                $("#show").empty();

                for (i = 0; i < data.data.length; i++) {

                    $("#show").append(
                        '<tr class="mt-3">' +
                        '<td data-th="編號">' + data.data[i].ID + '</td>' +
                        '<td data-th="品名">' + data.data[i].Pname + '</td>' +
                        '<td data-th="價錢">' + data.data[i].Price + '</td>' +
                        '<td data-th="數量">' + data.data[i].Pnum + '</td>' +
                        '<td data-th="訂購時間">' + data.data[i].Created_at + '</td>' +
                        '</tr>'

                    );

                    // console.log(data.data[i].Price);
                    mony = parseInt(data.data[i].Price) + mony;
                    // console.log(mony);
                }

                $("#show").append(
                    '<tr class="mt-3">' +
                    '<td>' + "總價錢:" + mony + '</td>' +
                    '<td>' + "有幾個便當:" + data.data.length + '</td>' +
                    '</tr>'
                );

                // console.log("總價錢:" + mony);
                // console.log("有幾個便當:" + data.data.length);

            },
            error: function (data) {
                console.log(data.message);
            }
        });

    }

    //篩選欄位資料方法
    function pValue() {

        if ($("#pname").val().length >= 2 && $("#pname").val().length <= 8) {

            $("#err_pname").html("正確").css("color", "green");

            pname_state = true;
        } else {

            $("#err_pname").html("2-8字").css("color", "red");

            pname_state = false;
        }

        if ($("#price").val() >= 1 && $("#price").val() <= 500) {

            $("#err_price").html("正確").css("color", "green");

            price_state = true;

        } else {

            $("#err_price").html("價錢1-500").css("color", "red");

            price_state = false;
        }

        if ($("#pnum").val() >= 1 && $("#pnum").val() <= 30) {

            $("#err_pnum").html("正確").css("color", "green");

            pnum_state = true;

        } else {

            $("#err_pnum").html("數量1-30").css("color", "red");

            pnum_state = false;
        }
    }

    //欄位清場
    function showClear() {

        $("#pname,#price,#pnum").val("");
        $("#err_pname,#err_price,#err_pnum").html("　");
    }

</script>

</html>